import*as e from"three";import*as t from"three/addons/lines/Line2.js";import*as n from"three/addons/lines/LineMaterial.js";import*as o from"three/addons/lines/LineGeometry.js";var s={d:(e,t)=>{for(var n in t)s.o(t,n)&&!s.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const i=(e=>{var t={};return s.d(t,e),t})({Audio:()=>e.Audio,AudioListener:()=>e.AudioListener,AudioLoader:()=>e.AudioLoader,BoxGeometry:()=>e.BoxGeometry,Color:()=>e.Color,DoubleSide:()=>e.DoubleSide,Fog:()=>e.Fog,Mesh:()=>e.Mesh,MeshBasicMaterial:()=>e.MeshBasicMaterial,PerspectiveCamera:()=>e.PerspectiveCamera,Raycaster:()=>e.Raycaster,Scene:()=>e.Scene,Vector2:()=>e.Vector2,WebGLRenderer:()=>e.WebGLRenderer}),a={CRASH_LEFT:{label:"Crash Left",lane:1,note:49},HAT_OPEN:{label:"Hat Open",lane:2,note:46},HAT_CLOSED:{label:"Hat Closed",lane:2,note:42},HAT_PEDAL:{label:"Hat Pedal",lane:2,note:44},SNARE_CENTER:{label:"Snare Center",lane:3,note:38},SNARE_RIM:{label:"Snare Rim",lane:3,note:40},TOM_ONE:{label:"Tom High",lane:4,note:48},TOM_TWO:{label:"Tom Medium",lane:5,note:45},TOM_FLOOR:{label:"Tom Floor",lane:6,note:43},KICK_RIGHT:{label:"Kick",lane:7,note:36},RIDE_EDGE:{label:"Ride Edge",lane:8,note:51}},l={CRASH_LEFT:new i.MeshBasicMaterial({color:39321,side:i.DoubleSide}),HAT_OPEN:new i.MeshBasicMaterial({color:4478361,side:i.DoubleSide}),HAT_CLOSED:new i.MeshBasicMaterial({color:7824896,side:i.DoubleSide}),HAT_PEDAL:new i.MeshBasicMaterial({color:10027008,side:i.DoubleSide}),SNARE_CENTER:new i.MeshBasicMaterial({color:8912896,side:i.DoubleSide}),SNARE_RIM:new i.MeshBasicMaterial({color:34816,side:i.DoubleSide}),TOM_ONE:new i.MeshBasicMaterial({color:7829248,side:i.DoubleSide}),TOM_TWO:new i.MeshBasicMaterial({color:5592456,side:i.DoubleSide}),TOM_FLOOR:new i.MeshBasicMaterial({color:34816,side:i.DoubleSide}),KICK_RIGHT:new i.MeshBasicMaterial({color:8934656,side:i.DoubleSide}),RIDE_EDGE:new i.MeshBasicMaterial({color:30583,side:i.DoubleSide})};function r(){localStorage.setItem("note_settings",JSON.stringify(c))}let c={...a};!function(){const e=localStorage.getItem("note_settings");e&&(c=JSON.parse(e))}();const d=Object.keys(c).reduce(((e,t)=>{const n=c[t];return e[n.lane]||(e[n.lane]=new Set),e[n.lane].add(t),e}),{}),u=[],m="reset",h="pause",p="edit",v="snap_forwards",g="snap_backwards",b="nudge_forwards",E="nudge_backwards",f="velocity_up",y="velocity_down",_="repeat_note",M="any_note",T="any_key",I="any_controller",B=153,k="pointer_up";function w(e,t,n){switch(e){case B:if(n>0)for(let o of u)o.command===e&&o.label===t&&o.action(t,n);break;case M:if(n>0)for(let o of u)o.command===e&&o.action(t,n);break;default:for(let o of u)o.command===e&&o.action(t,n)}}function S(e,t,n){u.push({command:e,label:t,action:n})}function L(e){document.getElementById("midi").innerHTML=e}let O=!1;function P(e){O=e}function A(e){L("Failed to get MIDI access")}function C(e){const t=e.data[0],n=e.data[1],o=e.data[2];if(153===t)o>0&&(w(M,n,o),w(B,n,o),w(I,n,o))}setInterval((()=>{if(O){const e=O.inputs;let t="";e.forEach((e=>{t+=e.name+"<br/>"})),e.forEach((e=>{e.onmidimessage=C})),""===t&&(t="Attach MIDI drum kit"),L(t)}}),1e3),navigator.requestMIDIAccess?navigator.requestMIDIAccess().then(P,A):L("Web MIDI API is not supported in this browser.");const x={Space:{command:m,lastEvent:""},Escape:{command:h,lastEvent:""},ArrowUp:{command:v,lastEvent:""},ArrowDown:{command:g,lastEvent:""},ArrowRight:{command:b,lastEvent:""},ArrowLeft:{command:E,lastEvent:""},Minus:{command:y,lastEvent:""},Equal:{command:f,lastEvent:""},Period:{command:_,lastEvent:""},KeyC:{command:B,label:"SNARE_RIM",value:75,lastEvent:""},KeyV:{command:B,label:"SNARE_CENTER",value:75,lastEvent:""},KeyQ:{command:B,label:"CRASH_LEFT",value:75,lastEvent:""},KeyW:{command:B,label:"HAT_PEDAL",value:100,lastEvent:""},KeyE:{command:B,label:"HAT_OPEN",value:75,lastEvent:""},KeyR:{command:B,label:"HAT_CLOSED",value:75,lastEvent:""},KeyU:{command:B,label:"TOM_ONE",value:75,lastEvent:""},KeyI:{command:B,label:"TOM_TWO",value:75,lastEvent:""},KeyO:{command:B,label:"TOM_FLOOR",value:75,lastEvent:""},KeyN:{command:B,label:"KICK_RIGHT",value:75,lastEvent:""},KeyP:{command:B,label:"RIDE_EDGE",value:75,lastEvent:""}};function N(){localStorage.setItem("key_settings",JSON.stringify(H))}let H={...x};!function(){const e=localStorage.getItem("key_settings");e&&(H=JSON.parse(e))}(),document.addEventListener("keydown",(e=>{if(e.preventDefault(),w(T,e.code),H[e.code]&&"keydown"!=H[e.code].lastEvent){if(H[e.code].lastEvent="keydown",H[e.code].command===B){const t=c[H[e.code].label].note;t>-1&&w(M,t,H[e.code].value)}const t=H[e.code].label?c[H[e.code].label].note:void 0;(void 0===t||t>-1)&&w(H[e.code].command,t,H[e.code].value)}})),document.addEventListener("keyup",(e=>{H[e.code]&&"keyup"!=H[e.code].lastEvent&&(H[e.code].lastEvent="keyup")}));const R=new i.Vector2;document.addEventListener("mousemove",(e=>{R.x=e.clientX/window.innerWidth*2-1,R.y=-e.clientY/window.innerHeight*2+1})),document.addEventListener("pointerup",(e=>{w(k,e.pointerType)})),document.addEventListener("wheel",(e=>{e.deltaY>0?w(b,0,0):w(E,0,0)}));const D="PRACTICE",$="PRACTICE_PAUSED",F="EDIT_PATTERN",G="EDIT_INPUT_SETTINGS";function K(e){const t=1/8;return 2*(.5625-t*e)}const V=(e=>{var t={};return s.d(t,e),t})({Line2:()=>t.Line2});const j=(e=>{var t={};return s.d(t,e),t})({LineMaterial:()=>n.LineMaterial});const z=(e=>{var t={};return s.d(t,e),t})({LineGeometry:()=>o.LineGeometry});const W=new class{constructor(){this._startTime=!1,this._bars=0,this._noteCount=0,this._hitCount=0,this._timeScale=4,this._mode=$}get mode(){return this._mode}set mode(e){this._mode=e}get startTime(){return this._startTime}set startTime(e){this._startTime=e}get bars(){return this._bars}set bars(e){this._bars=e}get noteCount(){return this._noteCount}set noteCount(e){this._noteCount=e,document.getElementById("hitPercentage").innerHTML=`${this.hitPercentage}`}get hitCount(){return this._hitCount}set hitCount(e){this._hitCount=e,document.getElementById("hitPercentage").innerHTML=`${this.hitPercentage}`}get hitPercentage(){return 0===this.noteCount?"":`${Number(this._hitCount/this._noteCount*100).toFixed(2)}%`}get timeScale(){return this._timeScale}get beats(){return this._bars/this._timeScale}set beats(e){this._bars=e*this._timeScale}},J="grooves/eighth";class U extends HTMLElement{connectedCallback(){this._value=J,this._level=!1}setOptions(){this.innerHTML=`\n      <label for="exerciseSelect">Exercise</label>\n      ${function(e){const t=X();let n="";if(t&&t.length>0){n=`\n        <optgroup label="Custom">\n        ${t.reduce(((e,t,n)=>e+`<option value="__CUSTOM__${n}">${t.name?t.name:`Slot ${n+1}`}</option>`),"")}\n        </optgroup>\n      `}return`\n      <select id="${e}">\n        ${n}\n        <optgroup label="Grooves">\n          <option value="grooves/eighth">Eighth note</option>\n          <option value="grooves/four_to_the_floor">Four to the floor</option>\n          <option value="grooves/shuffle">Shuffle</option>\n          <option value="grooves/sixteenth">Sixteenth note</option>\n          <option value="grooves/twelve_eight">12/8 groove</option>\n          <option value="grooves/twelve_eight_dance">12/8 dance</option>\n          <option value="grooves/twelve_eight_beat_1">12/8 beat 1</option>\n        </optgroup>\n        <optgroup label="Bounces">\n          <option value="bounces/catch_turn">Bounce catch turn</option>\n          <option value="bounces/catch_turn_soft">Bounce catch turn (light)</option>\n          <option value="bounces/triplets">Bounce triplets</option>\n          <option value="bounces/doubles">Bounce doubles</option>\n          <option value="bounces/doubles_reverse">Bounce doubles (reversed)</option>\n        </optgroup>\n        <optgroup label="Cross Stick">\n          <option value="cross_stick/quarters">Cross stick quarters</option>\n          <option value="cross_stick/basic">Cross stick basic</option>\n          <option value="cross_stick/beat_1">Cross stick beat 1</option>\n          <option value="cross_stick/beat_2">Cross stick beat 2</option>\n        </optgroup>\n        <optgroup label="Hats">\n          <option value="hat_openings/eighth_lead_close">8th Hi-hat openings (lead close)</option>\n          <option value="hat_openings/eighth_lead_open">8th Hi-hat openings (lead open)</option>\n          <option value="hat_openings/sixteenth_lead_close">16th Hi-hat openings (lead close)</option>\n          <option value="hat_openings/sixteenth_lead_open">16th Hi-hat openings (lead open)</option>\n          <option value="hat_openings/eighth_beat_1">8th Beat 1</option>\n          <option value="hat_openings/eighth_beat_2">8th Beat 2</option>\n          <option value="hat_openings/sixteenth_bark_1">16th bark 1</option>\n          <option value="hat_openings/sixteenth_bark_2">16th bark 2</option>\n          <option value="hat_openings/sixteenth_bark_3">16th bark 3 (snare)</option>\n          <option value="hat_openings/sixteenth_bark_4">16th bark 4 (snare)</option>\n          <option value="hat_openings/foot_control_1">Foot Control 1</option>\n          <option value="hat_openings/foot_control_2">Foot Control 2</option>\n          <option value="hat_openings/foot_control_3">Foot Control 3</option>\n        </optgroup>\n        <optgroup label="Flams">\n          <option value="flams/flam_basic">Flam Basic</option>\n          <option value="flams/flam_cross">Flam Cross</option>\n        </optgroup>\n        <optgroup label="Templates">\n          <option value="templates/twelve">Twelve</option>\n        </optgroup>\n      </select>   \n    `}("exerciseSelect")}\n      ${q(this._value)&&"EDIT_PATTERN"===W.mode?`\n          <div id="levelSettings" class="exerciseInputs">\n              <div style="display:inline-block">\n                <label for="linesPerBeat">Division</label>\n                <input type="number" id="linesPerBeat" value="${this._level.grid.linesPerBeat}" min="1" max="16" step="1" class="numberInput"/>\n              </div>\n              <div style="display:inline-block">\n                <label for="exerciseLength">Bars</label>\n                <input type="number" id="exerciseLength" value="${this._level.length}" min="1" max="8" step="1" class="numberInput"/>\n              </div>\n          </div>\n          `:""}\n      <div class="exerciseInputs">\n        <i id="deleteCustomExercise" class="fa-solid fa-trash" style="padding:5px;display:none"></i>\n        <i id="saveNewCustomExercise" class="fa-solid fa-circle-plus" style="padding:5px"></i>\n      </div>\n    `,document.getElementById("exerciseSelect").value=this._value,document.getElementById("exerciseSelect").addEventListener("change",(e=>{this._value=e.target.value,this.showControls()})),q(this._value)&&(document.getElementById("linesPerBeat").addEventListener("change",(e=>{this._level.grid.linesPerBeat=e.target.value,Y(this._level),this.setOptions(),this.dispatchEvent(new Event("change"))})),document.getElementById("exerciseLength").addEventListener("change",(e=>{this._level.length=e.target.value,Y(this._level),this.setOptions(),this.dispatchEvent(new Event("change"))}))),document.getElementById("deleteCustomExercise").addEventListener("click",(e=>{!function(e){if(q(e)){const t=Number(e.substring(10)),n=X();n.splice(t,1),localStorage.setItem("custom_exercises",JSON.stringify(n))}}(this._value),this._value=J,this.setOptions(),this.dispatchEvent(new Event("change"))})),document.getElementById("saveNewCustomExercise").addEventListener("click",(e=>{const t=function(e){const t=X()||[];return t.push(e),localStorage.setItem("custom_exercises",JSON.stringify(t)),t.length-1}(this._level);this._value=`__CUSTOM__${t}`,this.setOptions(),this.dispatchEvent(new Event("change"))})),this.showControls()}get value(){return this._value}get level(){return this._level}set level(e){this._level=e}async loadExercise(){this._level=await async function(e){if(q(e)){const t=Number(e.substring(10));return X()[t]}{let t=`./arrangements/${e}.json`,n=await fetch(t);return await n.json()}}(this.value),this.setOptions()}showControls(){q(this._value)?document.getElementById("deleteCustomExercise").style.display="inline":document.getElementById("deleteCustomExercise").style.display="none"}}function X(){const e=localStorage.getItem("custom_exercises");return!!e&&JSON.parse(e)}function q(e){return 0===e.indexOf("__CUSTOM__")}function Y(e){const t=document.getElementById("exerciseSelect").value;if(q(t)){const n=Number(t.substring(10)),o=X();o[n]=e,localStorage.setItem("custom_exercises",JSON.stringify(o))}}customElements.define("exercise-settings",U);const Z=new i.MeshBasicMaterial({color:16777045}),Q=new i.MeshBasicMaterial({color:7829503}),ee=new i.MeshBasicMaterial({color:255}),te=new i.MeshBasicMaterial({color:16711680}),ne=new i.MeshBasicMaterial({color:3381555,transparent:!0,opacity:.1}),oe=new j.LineMaterial({color:14540287,linewidth:2,alphaToCoverage:!1,fog:!0}),se=new j.LineMaterial({color:6710954,linewidth:1,alphaToCoverage:!1,fog:!0});let ie=[],ae=[],le=[],re=0,ce=0,de=!1,ue=!1;function me(e,t,n=!1){if(n){for(let n of e)for(let e of n.meshes)t.remove(e);e.length=0}else{let n=0,o=0;for(;n<e.length;){const s=e[n];if(s.time<W.bars-1.77)for(let e of s.meshes)t.remove(e);else e[o++]=s;n++}e.length=o}}function he(e,t,n){return t.countIn+n*e.length}function pe(e,t,n,o){const s=K(c[t.note].lane),a=e[1]/127,r=e[1]/127,d=[];d.push(.1*r,0,.5),d.push(-.1*r,0,.5),d.push(-.1*r,0,-.5),d.push(.1*r,0,-.5),d.push(.1*r,0,.5);var u=new z.LineGeometry;u.setPositions(d);var m=new V.Line2(u,oe);m.translateX(s),m.translateZ(o),m.scale.z=n.accuracyTime;const h=new i.BoxGeometry(.2*r,.5*a,1),p=new i.Mesh(h,l[t.note]);return p.translateX(s),p.translateY(-a/4),p.translateZ(o),p.scale.z=n.accuracyTime,{mesh:p,line:m}}function ve(e,t,n){const o=e;for(let e of t.tracks)for(let s of e.events)if(s[0]<t.length){const t=(s[0]+o)*W.timeScale,{mesh:i,line:a}=pe(s,e,playSettings,t);i.selectableEvent={track:e,time:t,event:s,meshes:[i,a],hit:!1,soft:!1,hard:!1},n.add(i),n.add(a),ie.push(i.selectableEvent)}}function ge(e,t,n){const o=1/t.grid.linesPerBeat;for(let a=0;a<=t.grid.linesPerBeat;a++){const l=e+a*o;if(W.modes!==F||l<=t.length){const t=(e+a*o)*W.timeScale;var s=new z.LineGeometry;s.setPositions([1,0,0,-1,0,0]);var i=new V.Line2(s,se);i.translateZ(t),n.add(i),ae.push({meshes:[i],time:t})}}}function be(e,t,n){const o=W.timeScale,s=W.bars+1.5*o;if(re<e.repeats)for(;he(e,t,re)*o<=s;){ve(he(e,t,re),e,n),re++}const i=(e.repeats*e.length+t.countIn)*o;for(;ce*o<s&&s<i;)ge(ce,e,n),ce++}function Ee(e){me(ae,e,!0),me(ie,e,!0),me(le,e,!0),re=0,ce=0,W.noteCount=0,W.hitCount=0}function fe(e,t){for(ve(0,e,t);ce*W.timeScale<e.length*W.timeScale;)ge(ce,e,t),ce++}function ye(e,t,n,o){let s=d[c[t].lane];const i=n.tracks.filter((e=>s.has(e.note))),a=o.accuracyTime/W.timeScale;for(let t of i)for(let n=0;n<t.events.length;n++){const o=t.events[n];if(e>o[0]-a&&e<o[0]+a)return{track:t,event:t.events[n]}}return!1}function _e(e,t,n,o,s){if(t&&n||de&&(t=de.note,n=de.velocity),t&&n){de={note:t,velocity:n};let i=s.tracks.find((e=>e.note===t));if(i||(i={note:t,events:[]},s.tracks.push(i)),!function(e,t,n,o){let s=d[c[t].lane];const i=n.tracks.filter((e=>s.has(e.note))),a=o.accuracyTime/W.timeScale;for(let t of i)for(let n=0;n<t.events.length;n++){const o=t.events[n];if(e>o[0]-a&&e<o[0]+a)return t.events.splice(n,1)}return!1}(e,t,s,playSettings))if(0==i.events.length)i.events.push([e,n]);else for(let t=0;t<i.events.length;t++){if(i.events[t][0]>e){0==t?i.events.unshift([e,n]):i.events.splice(t,0,[e,n]);break}if(t==i.events.length-1){i.events.push([e,n]);break}}Ee(o),fe(s,o)}}function Me(e,t,n,o=!0){return de=!1,Ee(n),o?(fe(e,n),function(e,t){const n=8*e.grid.linesPerBeat*e.length,o=8*e.grid.linesPerBeat,s=1/o;for(let a=1;a<=8;a++){const l=K(a);for(let r=0;r<n;r++){let n=r*s;r%o==0&&(n=Math.floor(n));const c=Array.from(d[a]),u=.15/c.length,m=u*c.length;c.forEach(((o,s)=>{const r=s*u-m/2+u/2,c=n*W.timeScale,d=new i.BoxGeometry(u,.01,2/(8*e.grid.linesPerBeat)),h=new i.Mesh(d,ne);h.translateX(l+r),h.translateZ(c),h.editHandle={time:n,lane:a,note:o},t.add(h)}))}}}(e,n),{subscribe:()=>{S(k,0,(()=>{if(ue){const o=ue.editHandle,s="HAT_PEDAL"===o.note?127:de&&"HAT_PEDAL"!==de.note?de.velocity:75;_e(o.time,o.note,s,n,e),ye(o.time,o.note,e,t)&&(ue.material=ne),Y(e)}})),S(f,0,(()=>{if(ue){const o=ue.editHandle,s=ye(o.time,o.note,e,t);s.event&&"HAT_PEDAL"!=s.track.note&&(s.event[1]=Math.min(s.event[1]+4,128),de={note:s.track.note,velocity:s.event[1]},t.playSound(de.note,de.velocity),Ee(n),fe(e,n),Y(e))}})),S(y,0,(()=>{if(ue){const o=ue.editHandle,s=ye(o.time,o.note,e,t);s.event&&"HAT_PEDAL"!=s.track.note&&(s.event[1]=Math.max(s.event[1]-4,20),de={note:s.track.note,velocity:s.event[1]},t.playSound(de.note,de.velocity),Ee(n),fe(e,n),Y(e))}}))},update:()=>{const n=new i.Raycaster;n.setFromCamera(R,Ie.camera);const o=n.intersectObjects(Ie.scene.children.filter((e=>e.editHandle)),!1);o.length>0?o.forEach((n=>{ue&&n.object!=ue&&(ue.material=ne),ue=n.object;const o=ue.editHandle;ye(o.time,o.note,e,t)||(ue.material=l[ue.editHandle.note])})):ue&&(ue.material=ne,ue=!1)},addNote:(t,o)=>{_e(W.beats,t,o,n,e),Y(e)}}):(be(e,t,n),{subscribe:()=>{},checkNoteOn:(e,o)=>{let s=!1,a=1/0,l=!1,r=0,d=!1;for(let u of ie){if(e==u.track.note){const e=W.bars-u.time;Math.abs(e)<a?(a=Math.abs(e),r=e,l=u.meshes[0]):d=!0}const m=W.bars>u.time-t.accuracyTime&&W.bars<u.time+t.accuracyTime,h=o>u.event[1]-t.accuracyVelocity&&o<u.event[1]+t.accuracyVelocity;if(e==u.track.note&&m){if(u.hit=!0,h)u.meshes[0].material=new i.MeshBasicMaterial({color:16777215}),le.push({time:u.time,meshes:[u.meshes[0]]});else{n.remove(u.meshes[0]),o<u.event[1]&&(u.soft=!0),o>u.event[1]&&(u.hard=!0);const e=K(c[u.track.note].lane),s=u.time,a=u.event[1]/127,l=u.event[1]/127,r=new i.BoxGeometry(.2*l,.5*a,t.accuracyTime),d=new i.Mesh(r,u.soft?Q:Z);d.translateX(e),d.translateY(-a/4),d.translateZ(s),n.add(d),u.meshes[0]=d}"HAT_CLOSED"!==e&&"HAT_PEDAL"!==e||t.sounds.HAT_OPEN&&t.sounds.HAT_OPEN.isPlaying&&t.sounds.HAT_OPEN.stop(),t.sounds[e]&&t.kitOn&&(t.sounds[e].isPlaying&&t.sounds[e].stop(),t.sounds[e].setVolume(o/128),t.sounds[e].play()),s=!0;break}if(d)break}s||("HAT_PEDAL"===e?t.sounds.HAT_PEDAL&&t.kitOn&&(t.sounds.HAT_PEDAL.isPlaying&&t.sounds.HAT_PEDAL.stop(),t.sounds.HAT_PEDAL.setVolume(o/128),t.sounds.HAT_PEDAL.play()):W.bars>0&&(t.sounds.FAIL&&(t.sounds.FAIL.isPlaying&&t.sounds.FAIL.stop(),t.sounds.FAIL.setVolume(o/128),t.sounds.FAIL.setPlaybackRate(1-r),t.sounds.FAIL.play()),Math.abs(r)<.2&&l&&(l.rotateX(-5*r),l.material=r>0?ee:te)))},update:()=>{for(let e of ae){const n=Math.abs(W.bars-e.time);if(n<=.05){const o=20*(.05-n),s=new i.Color(.5*o,.5*o,.9*o),a=new j.LineMaterial({color:s,linewidth:5,alphaToCoverage:!1});e.meshes[0].material=a,e.triggered||(t.sounds.METRONOME.isPlaying&&t.sounds.METRONOME.stop(),t.metronomeOn&&(e.time%1==0?t.sounds.METRONOME.setPlaybackRate(t.BPM/60*1.5):t.sounds.METRONOME.setPlaybackRate(t.BPM/60),t.sounds.METRONOME.play(Math.floor(n)),e.triggered=!0))}else n<1&&(e.meshes[0].material=se)}for(let e of le){const t=W.bars-e.time;if(t>0){const n=1-2*t,o=new i.Color(n,n,n);e.meshes[0].material=new i.MeshBasicMaterial({color:o}),e.meshes[0].translateY(-t/8)}}W.mode===D&&(!function(e){for(let t of e)t.time<W.bars-.2&&(t.checked||(t.checked=!0,W.noteCount++,!t.hit||t.soft||t.hard||W.hitCount++))}(ie),me(ae,n),me(ie,n),me(le,n)),be(e,t,n)}})}const Te=new i.MeshBasicMaterial({color:14540287});const Ie={kit:!1,eventManager:!1,renderer:!1,scene:!1,canvas:!1,camera:!1},Be=document.getElementById("playSettings"),ke=document.getElementById("editSettings"),we=document.getElementById("inputSettings"),Se=document.getElementById("exercise");let Le=1118532,Oe=window.innerWidth,Pe=window.innerHeight;function Ae(){return Math.max(Math.min(-Be.BPM/60,-.7),-2)}function Ce(){return Math.min(Math.max(Be.BPM/60,1),2)}function xe(){return 2*Math.PI*.62}Ie.camera=new i.PerspectiveCamera(70,Oe/Pe,.01,20),Ie.camera.position.z=Ae(),Ie.camera.position.y=Ce(),Ie.camera.rotation.z=Math.PI,Ie.camera.rotation.x=xe(),window.onresize=()=>{Oe=window.innerWidth,Pe=window.innerHeight,Ie.renderer&&Ie.renderer.setSize(Oe,Pe),Ie.camera&&(Ie.camera.aspect=Oe/Pe,Ie.camera.updateProjectionMatrix())};let Ne=0;function He(e){let t=0;W.startTime?(t=e-Ne,Ne=e):W.startTime=e,W.mode===D&&(W.bars+=t*(Be.BPM/60)/1e3),Ie.kit&&Ie.kit.update(Be),Ie.eventManager&&Ie.eventManager.update(),Ie.camera.position.z=Ae()+W.bars,Ie.camera.position.y=Ce(),Ie.camera.rotation.x=xe(),Ie.scene.fog=new i.Fog(Le,2,4*Ce()),Ie.renderer.render(Ie.scene,Ie.camera)}async function Re(){W.mode===D&&(W.mode=$),W.startTime=!1,W.bars=0,Ie.canvas&&(document.body.removeChild(Ie.canvas),Ie.renderer.dispose()),Ie.renderer=new i.WebGLRenderer({antialias:!0}),Ie.scene=new i.Scene,W.mode===F?(Le=1127185,Ie.scene.background=new i.Color(Le)):(Le=1118532,Ie.scene.background=new i.Color(Le)),u.length=0,S(m,0,(()=>{W.mode=$,Re()})),S(M,0,(()=>{W.mode===$?(W.mode=D,Be.sounds.METRONOME.isPlaying&&Be.sounds.METRONOME.stop(),Be.sounds.METRONOME.setPlaybackRate(Be.BPM/60)):W.mode===D&&W.bars>Se.level.length*W.timeScale*(Se.level.repeats+2)&&(W.mode=$,Be.sounds.METRONOME.setPlaybackRate(Be.BPM/60),Re())})),S(h,0,(()=>{W.mode===D?W.mode=$:W.mode===$&&(W.mode=D)})),S(p,0,(()=>{W.mode!==F?W.mode=F:W.mode=$,Re()})),console.log(JSON.stringify(Se.level)),W.mode===F?Ie.eventManager=Me(Se.level,Be,Ie.scene,!0):Ie.eventManager=Me(Se.level,Be,Ie.scene,!1),ke.subscribe(Se,Ie.eventManager),we.subscribe(),Ie.kit=function(e,t){const n=[];for(let o=1;o<=8;o++){const s=K(o),a=new i.Mesh(new i.BoxGeometry(.22,1,1),Te);a.translateX(s),a.rotation.x=.5*Math.PI,a.scale.x=.05,a.scale.y=e.accuracyTime,a.scale.z=.01;const l={mesh:a,lastTriggered:-1/0,velocity:0};n.push(l),t.add(a)}return{subscribe:e=>{for(let t of Object.keys(c))S(B,c[t].note,((o,s)=>{if(W.mode===F)e.addNote(t,s);else if(W.mode===D){const o=n[c[t].lane-1];o.mesh.scale.z=s/127*.5,o.mesh.position.y=-s/127/4,o.mesh.material=l[t],o.lastTriggered=W.bars,o.velocity=s,e&&e.checkNoteOn(t,s)}}))},update:e=>{for(let t of n){t.mesh.position.z=W.bars,t.mesh.scale.y=e.accuracyTime;const n=5*(W.bars-t.lastTriggered);if(n<1){const e=t.velocity/127*(1-n);t.mesh.scale.z=.5*e,t.mesh.scale.x=Math.max(e,.05),t.mesh.position.y=-e/4}else t.mesh.scale.z=.01,t.mesh.position.y=0,t.mesh.material=Te}}}}(Be,Ie.scene),Ie.kit.subscribe(Ie.eventManager),Ie.eventManager.subscribe(),Ie.renderer.setSize(Oe,Pe),Ie.renderer.setAnimationLoop(He),Ie.canvas=document.body.appendChild(Ie.renderer.domElement)}function De(e){const t=1*W.timeScale/e,n=Math.round(W.beats*e)/e*W.timeScale;return{closest:n,previous:n-t,next:n+t}}class $e extends HTMLElement{connectedCallback(){this._gameState=!1,this.render()}toggleEdit(e){w(p,0,0),W.mode===F?(document.getElementById("editButton").style.display="none",document.getElementById("editPanel").style.display="inline",document.getElementById("exercise").setOptions()):(document.getElementById("editButton").style.display="inline",document.getElementById("editPanel").style.display="none",document.getElementById("exercise").setOptions())}render(){this.innerHTML='\n        <input id="editButton" type="button" value="Edit"></input>\n        <div id="editPanel" style="display:none;">\n            <table id="editGrid" style="position: relative;margin-left: auto;">\n                <tr>\n                    <td><i id="nudgeBackwards" class="fa-lg fa-solid fa-backward"></i></td>\n                    <td><i id="snapBackwards" class="fa-lg fa-solid fa-backward-step"></i></td>\n                    <td><i id="snapForwards" class="fa-lg fa-solid fa-forward-step"></i></td>\n                    <td><i id="nudgeForwards" class="fa-lg fa-solid fa-forward"></i></td>\n                    <td><i id="repeatNote" class="fa-lg fa-solid fa-clone"></i></td>\n                </tr>\n            </table>\n            <br/>\n            <input id="doneButton" type="button" value="Done"></input>\n        </div>     \n    ',document.getElementById("editButton").addEventListener("click",this.toggleEdit.bind(this)),document.getElementById("doneButton").addEventListener("click",this.toggleEdit.bind(this)),document.getElementById("snapForwards").addEventListener("click",(()=>{w(v,0,0)})),document.getElementById("nudgeForwards").addEventListener("click",(()=>{w(b,0,0)})),document.getElementById("snapBackwards").addEventListener("click",(()=>{w(g,0,0)})),document.getElementById("nudgeBackwards").addEventListener("click",(()=>{w(E,0,0)})),document.getElementById("repeatNote").addEventListener("click",(()=>{w(_,0,0)}))}subscribe(e,t){S(v,0,(()=>{const{next:t}=De(e.level.grid.linesPerBeat);W.mode===F&&(t<e.level.length*W.timeScale?W.bars=t:W.bars=0)})),S(g,0,(()=>{const{previous:t}=De(e.level.grid.linesPerBeat);W.mode===F&&t>=0&&(W.bars=t)})),S(b,0,(()=>{const{next:t}=De(8*e.level.grid.linesPerBeat);W.mode===F&&(t<e.level.length*W.timeScale?W.bars=t:W.bars=0)})),S(E,0,(()=>{const{previous:t}=De(8*e.level.grid.linesPerBeat);W.mode===F&&t>=0&&(W.bars=t)})),S(_,0,(()=>{W.mode===F&&t.addNote()}))}}function Fe(e,t){const n=new i.AudioListener;e.add(n);const o=new i.Audio(n);return(new i.AudioLoader).load(t,(function(e){o.setBuffer(e),o.setLoop(!1),o.setVolume(.3)})),o}function Ge(e,t){e.children.filter((e=>"AudioListener"==e.type)).forEach((t=>e.remove(t)));return{METRONOME:Fe(e,`sounds/${t}/metronome.mp3`),FAIL:Fe(e,`sounds/${t}/fail.mp3`),KICK_RIGHT:Fe(e,`sounds/${t}/kick.mp3`),CRASH_LEFT:Fe(e,`sounds/${t}/crash_left.mp3`),HAT_CLOSED:Fe(e,`sounds/${t}/hat_closed.mp3`),HAT_OPEN:Fe(e,`sounds/${t}/hat_open.mp3`),HAT_PEDAL:Fe(e,`sounds/${t}/hat_pedal.mp3`),RIDE_EDGE:Fe(e,`sounds/${t}/ride_edge.mp3`),SNARE_CENTER:Fe(e,`sounds/${t}/snare_center.mp3`),SNARE_RIM:Fe(e,`sounds/${t}/snare_rim.mp3`),TOM_FLOOR:Fe(e,`sounds/${t}/tom_floor.mp3`),TOM_ONE:Fe(e,`sounds/${t}/tom_one.mp3`),TOM_TWO:Fe(e,`sounds/${t}/tom_two.mp3`)}}customElements.define("edit-settings",$e);class Ke extends HTMLElement{connectedCallback(){this._bpm=90,this._metronome_on=!1,this._sounds=Ge(Ie.camera,"kit1"),this.innerHTML='\n        <div>\n            <div style="display:inline-block">\n            <label for="accuracyTime">Time Accuracy</label>\n            <input type="number" id="accuracyTime" value="0.06" min="0.01" max="0.10" step="0.001" class="numberInput"/>  \n            </div>\n            <div style="display:inline-block">  \n            <label for="accuracyVelocity">Velocity</label>\n            <input type="number" id="accuracyVelocity" value="24" min="8" max="64" step="8" class="numberInput"/>\n            </div>\n        </div>\n        <br/>    \n        <div>\n            <div style="display:inline-block">  \n            <label for="countIn">Count In</label>\n            <input type="number" id="countIn" value="1" min="1" max="4" step="1" class="numberInput"/>\n            </div>  \n            <div style="display:inline-block"> \n            <label for="BPM">BPM</label>\n            <input type="number" id="BPM" value="90" min="20" max="400" step="1" class="numberInput"/>\n            </div>\n        </div>\n        <br/><br/>\n        <div style="display:block">  \n        <i id="metronomeIcon" class="fa-2xl fa-solid fa-volume-xmark" style="margin-right:10px"></i>\n        <select id="kitSelect">\n          <option value="none">None</option>\n          <option value="kit1" selected>Kit 1</option>\n          <option value="kit2">Kit 2</option>\n          <option value="kit3">Kit 3</option>\n        </select>\n        </div>\n        <br/><br/>\n        <input type="button" id="restart" value="Restart"/>        \n        ',document.getElementById("BPM").addEventListener("change",(e=>{const t=Number(e.target.value);t&&NaN!==t&&(this._bpm=t)})),document.getElementById("kitSelect").addEventListener("change",(e=>{"none"!=e.target.value&&(this._sounds=Ge(Ie.camera,e.target.value))})),document.getElementById("metronomeIcon").addEventListener("click",(e=>{this._metronome_on=!this._metronome_on,document.getElementById("metronomeIcon").className=this._metronome_on?"fa-2xl fa-solid fa-volume-high":"fa-2xl fa-solid fa-volume-xmark"}))}get accuracyTime(){return Number(document.getElementById("accuracyTime").value)}get accuracyVelocity(){return Number(document.getElementById("accuracyVelocity").value)}get countIn(){return Number(document.getElementById("countIn").value)}get BPM(){return this._bpm}get metronomeOn(){return this._metronome_on}get sounds(){return this._sounds}get kitOn(){return"none"!=document.getElementById("kitSelect").value}playSound(e,t){this.sounds[e]&&this.kitOn&&(this.sounds[e].isPlaying&&this.sounds[e].stop(),t&&this.sounds[e].setVolume(t/128),this.sounds[e].play())}}customElements.define("play-settings",Ke);class Ve extends HTMLElement{connectedCallback(){this.selected=!1,this.innerHTML='\n        <div style="display: inline-block; margin-left: 1rem"><i id="openInputSettings" class="fa-solid fa-drum"></i></div>\n        <dialog id="inputSettingsDialog">\n          <div id="noteElements"></div>\n          <div>\n          <div class="buttonStrip">\n            <div><input type="button" id="resetInputSettings" value="Reset"></input></div>\n            <div><input type="button" id="closeInputSettings" value="Done"></input></div>\n          </div> \n          </div>\n        </dialog>\n        ',document.getElementById("openInputSettings").addEventListener("click",(()=>{document.getElementById("inputSettingsDialog").showModal(),this.previousMode=W.mode,W.mode=G})),document.getElementById("closeInputSettings").addEventListener("click",(()=>{document.getElementById("inputSettingsDialog").close(),W.mode=this.previousMode,w(m,0,0)})),document.getElementById("resetInputSettings").addEventListener("click",(()=>{!function(){for(let e in x)H[e]={...x[e]};N()}(),function(){for(let e in a)c[e]={...a[e]};r()}(),this.updateNoteElements()})),this.updateNoteElements()}updateNoteElements(){const e=`<table>${Object.keys(c).reduce(((e,t)=>{let n="";for(let e in H)H[e].label===t&&(n=e);const o=`SETTINGS_${t}`;this.selected||(this.selected=o);const s=n.substring(3),i=-1==c[t].note?"":c[t].note;return e+=`<tr><td id="${o}" class="inputBinding ${this.selected===o?"selected":""}">${c[t].label}</td><td>${s}</td><td>${i}</td></tr>`}),"")}</table>`;document.getElementById("noteElements").innerHTML=e,document.querySelectorAll(".inputBinding").forEach((e=>{e.addEventListener("click",(e=>{this.selected=e.target.id,this.updateNoteElements()}))}))}subscribe(){S(T,0,(e=>{W.mode===G&&0===e.indexOf("Key")&&(!function(e,t){for(let t in H)if(0===t.indexOf("Key")&&H[t].label===e){delete H[t];break}H[t]={command:B,label:e,value:75,lastEvent:""},N()}(this.selected.substring(9),e),this.updateNoteElements())})),S(I,0,((e,t)=>{W.mode===G&&(!function(e,t){for(let e of Object.keys(c))c[e].note===t&&(c[e]={...c[e],note:-1});c[e]={...c[e],note:t},r()}(this.selected.substring(9),e),this.updateNoteElements())}))}}customElements.define("input-settings",Ve),async function(){await async function(){setTimeout((async()=>{await Se.loadExercise(),document.getElementById("restart").addEventListener("click",(()=>{Re()})),document.getElementById("exercise").addEventListener("change",(async()=>{await Se.loadExercise(),await Re()})),document.getElementById("playSettings").addEventListener("change",(async()=>{W.mode===D&&(W.mode=$),W.mode===$&&updateEvents(Be,Ie.scene)})),await Re()}),100)}()}();